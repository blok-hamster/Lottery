"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSolidityFiles = exports.getPackageJson = exports.getJavascriptFiles = exports.getTruffleConfig = exports.getSolidityVersions = exports.getSolidityVersionBy = exports.modifyTruffleBoxWith = void 0;
const path_1 = require("path");
const shelljs_1 = require("shelljs");
/**
 * Modify a truffle box with the given solidity version
 *
 * @param solidityVersion A tuple of alias and version of a solidity version, e.g ['v0.4', '0.4.24']
 * @param path The path to the truffle box
 * @param dryRun Whether to actually modify the files in-place or to print the modified files to stdout
 */
function modifyTruffleBoxWith([solcVersionAlias, solcVersion], path, dryRun) {
    const solVersionToOzversion = {
        '0.5.0': '2.3.0',
        '0.4.24': '2.0.0',
    };
    const ozVersion = solVersionToOzversion[solcVersion];
    convertPackageJson(path, ozVersion, solVersionToOzversion, solcVersion, dryRun);
    convertTruffleConfig(path, solcVersion, dryRun);
    convertSolidityFiles(path, ozVersion, dryRun, solcVersionAlias, solcVersion);
    convertJavascriptFiles(path, solcVersionAlias, dryRun);
}
exports.modifyTruffleBoxWith = modifyTruffleBoxWith;
/**
 * Get a solidity version by its alias or version number
 *
 * @param versionAliasOrVersion Either a solidity version alias "v0.6" | "0.6" or its full version "0.6.2"
 * @throws error if version given could not be found
 */
function getSolidityVersionBy(versionAliasOrVersion) {
    const versions = getSolidityVersions();
    const version = versions.find(([alias, full]) => alias.replace('v', '') === versionAliasOrVersion.replace('v', '') ||
        full === versionAliasOrVersion);
    if (!version) {
        throw Error(`Could not find given version, here are the available versions: ${versions}`);
    }
    return version;
}
exports.getSolidityVersionBy = getSolidityVersionBy;
/**
 * Get a list of available solidity versions based on what's published in @chainlink/contracts
 *
 * The returned format is [alias, version] where alias can be "v0.6" | "0.6" and full version can be "0.6.2"
 */
function getSolidityVersions() {
    // eslint-disable-next-line @typescript-eslint/no-var-requires
    const config = require('@chainlink/contracts/app.config.json');
    return Object.entries(config.compilerSettings.versions).filter(([, v]) => config.publicVersions.find((pv) => pv === v));
}
exports.getSolidityVersions = getSolidityVersions;
/**
 * Get the path to the truffle config
 *
 * @param basePath The path to the truffle box
 */
function getTruffleConfig(basePath) {
    return path_1.join(basePath, 'truffle-config.js');
}
exports.getTruffleConfig = getTruffleConfig;
/**
 * Get a list of all javascript files in the truffle box
 *
 * @param basePath The path to the truffle box
 */
function getJavascriptFiles(basePath) {
    const directories = ['scripts', 'test', 'migrations'];
    return directories
        .map((d) => shelljs_1.ls(path_1.join(basePath, d, '**', '*.js')))
        .reduce((prev, next) => {
        return prev.concat(next);
    }, []);
}
exports.getJavascriptFiles = getJavascriptFiles;
/**
 * Get path to the package.json
 *
 * @param basePath The path to the truffle box
 */
function getPackageJson(basePath) {
    return path_1.join(basePath, 'package.json');
}
exports.getPackageJson = getPackageJson;
/**
 * Get a list of all solidity files in the truffle box
 *
 * @param basePath The path to the truffle box
 */
function getSolidityFiles(basePath) {
    return [...shelljs_1.ls(path_1.join(basePath, 'contracts', '**', '*.sol'))];
}
exports.getSolidityFiles = getSolidityFiles;
function convertPackageJson(path, ozVersion, solVersionToOzversion, solcVersion, dryRun) {
    const packageJson = getPackageJson(path);
    if (ozVersion !== '2.0.0') {
        replaceInFile(`"openzeppelin-solidity": "1.12.0"`, `"@openzeppelin/contracts": "${solVersionToOzversion[solcVersion]}"`, [packageJson], dryRun);
    }
}
function convertTruffleConfig(path, solcVersion, dryRun) {
    const truffleConfig = getTruffleConfig(path);
    replaceInFile("version: '0.4.24'", `version: '${solcVersion}'`, [truffleConfig], dryRun);
}
function convertSolidityFiles(path, ozVersion, dryRun, solcVersionAlias, solcVersion) {
    const solFiles = getSolidityFiles(path);
    if (ozVersion !== '2.0.0') {
        replaceInFile('import "openzeppelin-solidity', `import "@openzeppelin`, solFiles, dryRun);
    }
    replaceInFile('@chainlink/contracts/src/v0.4', `@chainlink/contracts/src/${solcVersionAlias}`, solFiles, dryRun);
    replaceInFile('pragma solidity 0.4.24;', `pragma solidity ${solcVersion};`, solFiles, dryRun);
}
function convertJavascriptFiles(path, solcVersionAlias, dryRun) {
    const jsFiles = getJavascriptFiles(path);
    replaceInFile('@chainlink/contracts/truffle/v0.4', `@chainlink/contracts/truffle/${solcVersionAlias}`, jsFiles, dryRun);
    // replace linktoken back to v0.4
    replaceInFile(`@chainlink/contracts/truffle/${solcVersionAlias}/LinkToken`, '@chainlink/contracts/truffle/v0.4/LinkToken', jsFiles, dryRun);
}
function replaceInFile(regex, replacement, files, dryRun) {
    if (dryRun) {
        const { stderr, stdout } = shelljs_1.sed(regex, replacement, files);
        if (stdout) {
            console.log(stdout);
        }
        if (stderr) {
            console.error(stderr);
        }
    }
    else {
        shelljs_1.sed('-i', regex, replacement, files);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJ1ZmZsZS1ib3guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvdHJ1ZmZsZS1ib3gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQTJCO0FBQzNCLHFDQUFpQztBQUdqQzs7Ozs7O0dBTUc7QUFDSCxTQUFnQixvQkFBb0IsQ0FDbEMsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQW1CLEVBQ2pELElBQVksRUFDWixNQUFlO0lBRWYsTUFBTSxxQkFBcUIsR0FBMkI7UUFDcEQsT0FBTyxFQUFFLE9BQU87UUFDaEIsUUFBUSxFQUFFLE9BQU87S0FDbEIsQ0FBQTtJQUNELE1BQU0sU0FBUyxHQUFHLHFCQUFxQixDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBRXBELGtCQUFrQixDQUNoQixJQUFJLEVBQ0osU0FBUyxFQUNULHFCQUFxQixFQUNyQixXQUFXLEVBQ1gsTUFBTSxDQUNQLENBQUE7SUFDRCxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBQy9DLG9CQUFvQixDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLFdBQVcsQ0FBQyxDQUFBO0lBQzVFLHNCQUFzQixDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQTtBQUN4RCxDQUFDO0FBckJELG9EQXFCQztBQUVEOzs7OztHQUtHO0FBQ0gsU0FBZ0Isb0JBQW9CLENBQUMscUJBQTZCO0lBQ2hFLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixFQUFFLENBQUE7SUFDdEMsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FDM0IsQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQ2hCLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxLQUFLLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFB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QUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQTtLQUNyQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCdcbmltcG9ydCB7IGxzLCBzZWQgfSBmcm9tICdzaGVsbGpzJ1xuaW1wb3J0IHsgQXBwIH0gZnJvbSAnLi9jb25maWcnXG5cbi8qKlxuICogTW9kaWZ5IGEgdHJ1ZmZsZSBib3ggd2l0aCB0aGUgZ2l2ZW4gc29saWRpdHkgdmVyc2lvblxuICpcbiAqIEBwYXJhbSBzb2xpZGl0eVZlcnNpb24gQSB0dXBsZSBvZiBhbGlhcyBhbmQgdmVyc2lvbiBvZiBhIHNvbGlkaXR5IHZlcnNpb24sIGUuZyBbJ3YwLjQnLCAnMC40LjI0J11cbiAqIEBwYXJhbSBwYXRoIFRoZSBwYXRoIHRvIHRoZSB0cnVmZmxlIGJveFxuICogQHBhcmFtIGRyeVJ1biBXaGV0aGVyIHRvIGFjdHVhbGx5IG1vZGlmeSB0aGUgZmlsZXMgaW4tcGxhY2Ugb3IgdG8gcHJpbnQgdGhlIG1vZGlmaWVkIGZpbGVzIHRvIHN0ZG91dFxuICovXG5leHBvcnQgZnVuY3Rpb24gbW9kaWZ5VHJ1ZmZsZUJveFdpdGgoXG4gIFtzb2xjVmVyc2lvbkFsaWFzLCBzb2xjVmVyc2lvbl06IFtzdHJpbmcsIHN0cmluZ10sXG4gIHBhdGg6IHN0cmluZyxcbiAgZHJ5UnVuOiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IHNvbFZlcnNpb25Ub096dmVyc2lvbjogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAnMC41LjAnOiAnMi4zLjAnLFxuICAgICcwLjQuMjQnOiAnMi4wLjAnLFxuICB9XG4gIGNvbnN0IG96VmVyc2lvbiA9IHNvbFZlcnNpb25Ub096dmVyc2lvbltzb2xjVmVyc2lvbl1cblxuICBjb252ZXJ0UGFja2FnZUpzb24oXG4gICAgcGF0aCxcbiAgICBvelZlcnNpb24sXG4gICAgc29sVmVyc2lvblRvT3p2ZXJzaW9uLFxuICAgIHNvbGNWZXJzaW9uLFxuICAgIGRyeVJ1bixcbiAgKVxuICBjb252ZXJ0VHJ1ZmZsZUNvbmZpZyhwYXRoLCBzb2xjVmVyc2lvbiwgZHJ5UnVuKVxuICBjb252ZXJ0U29saWRpdHlGaWxlcyhwYXRoLCBvelZlcnNpb24sIGRyeVJ1biwgc29sY1ZlcnNpb25BbGlhcywgc29sY1ZlcnNpb24pXG4gIGNvbnZlcnRKYXZhc2NyaXB0RmlsZXMocGF0aCwgc29sY1ZlcnNpb25BbGlhcywgZHJ5UnVuKVxufVxuXG4vKipcbiAqIEdldCBhIHNvbGlkaXR5IHZlcnNpb24gYnkgaXRzIGFsaWFzIG9yIHZlcnNpb24gbnVtYmVyXG4gKlxuICogQHBhcmFtIHZlcnNpb25BbGlhc09yVmVyc2lvbiBFaXRoZXIgYSBzb2xpZGl0eSB2ZXJzaW9uIGFsaWFzIFwidjAuNlwiIHwgXCIwLjZcIiBvciBpdHMgZnVsbCB2ZXJzaW9uIFwiMC42LjJcIlxuICogQHRocm93cyBlcnJvciBpZiB2ZXJzaW9uIGdpdmVuIGNvdWxkIG5vdCBiZSBmb3VuZFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0U29saWRpdHlWZXJzaW9uQnkodmVyc2lvbkFsaWFzT3JWZXJzaW9uOiBzdHJpbmcpIHtcbiAgY29uc3QgdmVyc2lvbnMgPSBnZXRTb2xpZGl0eVZlcnNpb25zKClcbiAgY29uc3QgdmVyc2lvbiA9IHZlcnNpb25zLmZpbmQoXG4gICAgKFthbGlhcywgZnVsbF0pID0+XG4gICAgICBhbGlhcy5yZXBsYWNlKCd2JywgJycpID09PSB2ZXJzaW9uQWxpYXNPclZlcnNpb24ucmVwbGFjZSgndicsICcnKSB8fFxuICAgICAgZnVsbCA9PT0gdmVyc2lvbkFsaWFzT3JWZXJzaW9uLFxuICApXG4gIGlmICghdmVyc2lvbikge1xuICAgIHRocm93IEVycm9yKFxuICAgICAgYENvdWxkIG5vdCBmaW5kIGdpdmVuIHZlcnNpb24sIGhlcmUgYXJlIHRoZSBhdmFpbGFibGUgdmVyc2lvbnM6ICR7dmVyc2lvbnN9YCxcbiAgICApXG4gIH1cblxuICByZXR1cm4gdmVyc2lvblxufVxuXG4vKipcbiAqIEdldCBhIGxpc3Qgb2YgYXZhaWxhYmxlIHNvbGlkaXR5IHZlcnNpb25zIGJhc2VkIG9uIHdoYXQncyBwdWJsaXNoZWQgaW4gQGNoYWlubGluay9jb250cmFjdHNcbiAqXG4gKiBUaGUgcmV0dXJuZWQgZm9ybWF0IGlzIFthbGlhcywgdmVyc2lvbl0gd2hlcmUgYWxpYXMgY2FuIGJlIFwidjAuNlwiIHwgXCIwLjZcIiBhbmQgZnVsbCB2ZXJzaW9uIGNhbiBiZSBcIjAuNi4yXCJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFNvbGlkaXR5VmVyc2lvbnMoKTogW3N0cmluZywgc3RyaW5nXVtdIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXNcbiAgY29uc3QgY29uZmlnOiBBcHAgPSByZXF1aXJlKCdAY2hhaW5saW5rL2NvbnRyYWN0cy9hcHAuY29uZmlnLmpzb24nKVxuXG4gIHJldHVybiBPYmplY3QuZW50cmllcyhjb25maWcuY29tcGlsZXJTZXR0aW5ncy52ZXJzaW9ucykuZmlsdGVyKChbLCB2XSkgPT5cbiAgICBjb25maWcucHVibGljVmVyc2lvbnMuZmluZCgocHYpID0+IHB2ID09PSB2KSxcbiAgKVxufVxuXG4vKipcbiAqIEdldCB0aGUgcGF0aCB0byB0aGUgdHJ1ZmZsZSBjb25maWdcbiAqXG4gKiBAcGFyYW0gYmFzZVBhdGggVGhlIHBhdGggdG8gdGhlIHRydWZmbGUgYm94XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRUcnVmZmxlQ29uZmlnKGJhc2VQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gam9pbihiYXNlUGF0aCwgJ3RydWZmbGUtY29uZmlnLmpzJylcbn1cblxuLyoqXG4gKiBHZXQgYSBsaXN0IG9mIGFsbCBqYXZhc2NyaXB0IGZpbGVzIGluIHRoZSB0cnVmZmxlIGJveFxuICpcbiAqIEBwYXJhbSBiYXNlUGF0aCBUaGUgcGF0aCB0byB0aGUgdHJ1ZmZsZSBib3hcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEphdmFzY3JpcHRGaWxlcyhiYXNlUGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xuICBjb25zdCBkaXJlY3RvcmllcyA9IFsnc2NyaXB0cycsICd0ZXN0JywgJ21pZ3JhdGlvbnMnXVxuXG4gIHJldHVybiBkaXJlY3Rvcmllc1xuICAgIC5tYXAoKGQpID0+IGxzKGpvaW4oYmFzZVBhdGgsIGQsICcqKicsICcqLmpzJykpKVxuICAgIC5yZWR1Y2U8c3RyaW5nW10+KChwcmV2LCBuZXh0KSA9PiB7XG4gICAgICByZXR1cm4gcHJldi5jb25jYXQobmV4dClcbiAgICB9LCBbXSlcbn1cblxuLyoqXG4gKiBHZXQgcGF0aCB0byB0aGUgcGFja2FnZS5qc29uXG4gKlxuICogQHBhcmFtIGJhc2VQYXRoIFRoZSBwYXRoIHRvIHRoZSB0cnVmZmxlIGJveFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGFja2FnZUpzb24oYmFzZVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBqb2luKGJhc2VQYXRoLCAncGFja2FnZS5qc29uJylcbn1cblxuLyoqXG4gKiBHZXQgYSBsaXN0IG9mIGFsbCBzb2xpZGl0eSBmaWxlcyBpbiB0aGUgdHJ1ZmZsZSBib3hcbiAqXG4gKiBAcGFyYW0gYmFzZVBhdGggVGhlIHBhdGggdG8gdGhlIHRydWZmbGUgYm94XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRTb2xpZGl0eUZpbGVzKGJhc2VQYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gIHJldHVybiBbLi4ubHMoam9pbihiYXNlUGF0aCwgJ2NvbnRyYWN0cycsICcqKicsICcqLnNvbCcpKV1cbn1cblxuZnVuY3Rpb24gY29udmVydFBhY2thZ2VKc29uKFxuICBwYXRoOiBzdHJpbmcsXG4gIG96VmVyc2lvbjogc3RyaW5nLFxuICBzb2xWZXJzaW9uVG9PenZlcnNpb246IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gIHNvbGNWZXJzaW9uOiBzdHJpbmcsXG4gIGRyeVJ1bjogYm9vbGVhbixcbikge1xuICBjb25zdCBwYWNrYWdlSnNvbiA9IGdldFBhY2thZ2VKc29uKHBhdGgpXG4gIGlmIChvelZlcnNpb24gIT09ICcyLjAuMCcpIHtcbiAgICByZXBsYWNlSW5GaWxlKFxuICAgICAgYFwib3BlbnplcHBlbGluLXNvbGlkaXR5XCI6IFwiMS4xMi4wXCJgLFxuICAgICAgYFwiQG9wZW56ZXBwZWxpbi9jb250cmFjdHNcIjogXCIke3NvbFZlcnNpb25Ub096dmVyc2lvbltzb2xjVmVyc2lvbl19XCJgLFxuICAgICAgW3BhY2thZ2VKc29uXSxcbiAgICAgIGRyeVJ1bixcbiAgICApXG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydFRydWZmbGVDb25maWcoXG4gIHBhdGg6IHN0cmluZyxcbiAgc29sY1ZlcnNpb246IHN0cmluZyxcbiAgZHJ5UnVuOiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IHRydWZmbGVDb25maWcgPSBnZXRUcnVmZmxlQ29uZmlnKHBhdGgpXG4gIHJlcGxhY2VJbkZpbGUoXG4gICAgXCJ2ZXJzaW9uOiAnMC40LjI0J1wiLFxuICAgIGB2ZXJzaW9uOiAnJHtzb2xjVmVyc2lvbn0nYCxcbiAgICBbdHJ1ZmZsZUNvbmZpZ10sXG4gICAgZHJ5UnVuLFxuICApXG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRTb2xpZGl0eUZpbGVzKFxuICBwYXRoOiBzdHJpbmcsXG4gIG96VmVyc2lvbjogc3RyaW5nLFxuICBkcnlSdW46IGJvb2xlYW4sXG4gIHNvbGNWZXJzaW9uQWxpYXM6IHN0cmluZyxcbiAgc29sY1ZlcnNpb246IHN0cmluZyxcbikge1xuICBjb25zdCBzb2xGaWxlcyA9IGdldFNvbGlkaXR5RmlsZXMocGF0aClcbiAgaWYgKG96VmVyc2lvbiAhPT0gJzIuMC4wJykge1xuICAgIHJlcGxhY2VJbkZpbGUoXG4gICAgICAnaW1wb3J0IFwib3BlbnplcHBlbGluLXNvbGlkaXR5JyxcbiAgICAgIGBpbXBvcnQgXCJAb3BlbnplcHBlbGluYCxcbiAgICAgIHNvbEZpbGVzLFxuICAgICAgZHJ5UnVuLFxuICAgIClcbiAgfVxuICByZXBsYWNlSW5GaWxlKFxuICAgICdAY2hhaW5saW5rL2NvbnRyYWN0cy9zcmMvdjAuNCcsXG4gICAgYEBjaGFpbmxpbmsvY29udHJhY3RzL3NyYy8ke3NvbGNWZXJzaW9uQWxpYXN9YCxcbiAgICBzb2xGaWxlcyxcbiAgICBkcnlSdW4sXG4gIClcbiAgcmVwbGFjZUluRmlsZShcbiAgICAncHJhZ21hIHNvbGlkaXR5IDAuNC4yNDsnLFxuICAgIGBwcmFnbWEgc29saWRpdHkgJHtzb2xjVmVyc2lvbn07YCxcbiAgICBzb2xGaWxlcyxcbiAgICBkcnlSdW4sXG4gIClcbn1cblxuZnVuY3Rpb24gY29udmVydEphdmFzY3JpcHRGaWxlcyhcbiAgcGF0aDogc3RyaW5nLFxuICBzb2xjVmVyc2lvbkFsaWFzOiBzdHJpbmcsXG4gIGRyeVJ1bjogYm9vbGVhbixcbikge1xuICBjb25zdCBqc0ZpbGVzID0gZ2V0SmF2YXNjcmlwdEZpbGVzKHBhdGgpXG4gIHJlcGxhY2VJbkZpbGUoXG4gICAgJ0BjaGFpbmxpbmsvY29udHJhY3RzL3RydWZmbGUvdjAuNCcsXG4gICAgYEBjaGFpbmxpbmsvY29udHJhY3RzL3RydWZmbGUvJHtzb2xjVmVyc2lvbkFsaWFzfWAsXG4gICAganNGaWxlcyxcbiAgICBkcnlSdW4sXG4gIClcbiAgLy8gcmVwbGFjZSBsaW5rdG9rZW4gYmFjayB0byB2MC40XG4gIHJlcGxhY2VJbkZpbGUoXG4gICAgYEBjaGFpbmxpbmsvY29udHJhY3RzL3RydWZmbGUvJHtzb2xjVmVyc2lvbkFsaWFzfS9MaW5rVG9rZW5gLFxuICAgICdAY2hhaW5saW5rL2NvbnRyYWN0cy90cnVmZmxlL3YwLjQvTGlua1Rva2VuJyxcbiAgICBqc0ZpbGVzLFxuICAgIGRyeVJ1bixcbiAgKVxufVxuXG5mdW5jdGlvbiByZXBsYWNlSW5GaWxlKFxuICByZWdleDogc3RyaW5nIHwgUmVnRXhwLFxuICByZXBsYWNlbWVudDogc3RyaW5nLFxuICBmaWxlczogc3RyaW5nW10sXG4gIGRyeVJ1bjogYm9vbGVhbixcbikge1xuICBpZiAoZHJ5UnVuKSB7XG4gICAgY29uc3QgeyBzdGRlcnIsIHN0ZG91dCB9ID0gc2VkKHJlZ2V4LCByZXBsYWNlbWVudCwgZmlsZXMpXG4gICAgaWYgKHN0ZG91dCkge1xuICAgICAgY29uc29sZS5sb2coc3Rkb3V0KVxuICAgIH1cbiAgICBpZiAoc3RkZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKHN0ZGVycilcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc2VkKCctaScsIHJlZ2V4LCByZXBsYWNlbWVudCwgZmlsZXMpXG4gIH1cbn1cbiJdfQ==